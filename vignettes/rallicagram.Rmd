---
title: "rallicagram"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{rallicagram}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE, message=FALSE, warning=FALSE}
library(knitr)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  out.width = "70%",
  dpi = 400,
  fig.align = "center",
  dev = "png",
  fig.width = 7,
  fig.height = 5
)
```

```{r packages, echo=FALSE}
library(rallicagram)
```

`rallicagram` is a R wrapper for the [Gallicagram API](https://regicid.github.io/api). More info on Gallicagram and its API can be found on a [preprint](https://osf.io/preprints/socarxiv/84bf3/) by Gallicagram developers [
Benoît de Courson](https://regicid.github.io/) and [Benjamin Azoulay](https://benjamin-azoulay.my.canva.site/), on the "Notice" tab of the [Gallicagram website](https://shiny.ens-paris-saclay.fr/app/gallicagram) and on the [API docuemntation](https://regicid.github.io/api).

# Main functions

## Occurrences

The main function in this package, `gallicagram`, builds a data frame with the yearly, monthly or daily proportion of mentions of a term in one of the three corpora between two specified dates. 

This function corresponds to the `Query` route of the [API](https://regicid.github.io/api).

```{r ex_occur}
ex_occur <- gallicagram(
  keyword = "président",
  corpus = "lemonde",
  from = 1960,
  to = 1970,
  resolution = "monthly"
)
```

Here is an example of part of the output:

```{r kable_occur, echo=FALSE}
ex_occur |>
  utils::head() |>
  knitr::kable()
```

## Occurences for all copora and longest period

The function `gallicagram_all` enables to retrieve the yearly proportion of occurrences of a keyword in each of the corpora for the longest time range for which the data is available and reliable. 

It only takes one parameter: the keyword of interest:

```{r ex_all, eval=FALSE}
gallicagram_all("président")
```

## Co-occurrences

`gallicagram_cooccur` builds a data frame with the yearly, monthly or daily proportion of mentions of close co-occurrences of two keywords in one of the three corpora between two specified dates.

Close co-occurrences correspond to the number of 3-grams (4-grams in the *Le Monde* corpus) that contain the two keywords. This function corresponds to the `Contain` route of the [API](https://regicid.github.io/api).

The parameter `keywords` takes a character vector of length two as input.

```{r ex_cooccur}
ex_cooccur <- gallicagram_cooccur(
  keywords = c("président", "république"),
  corpus = "lemonde",
  from = 1960,
  to = 1970,
  resolution = "monthly"
)
```

Here is an example of part of the output:

```{r kable_cooccur, echo=FALSE}
ex_cooccur |>
  utils::head() |>
  knitr::kable()
```

It might also be helpful to have the keywords in two separate columns. To do that, one can use `tidyr::separate`:

```{r cooccur_sep}
ex_cooccur_sep <- ex_cooccur |> 
  tidyr::separate(keywords, into = c("keyword_1", "keyword_2"), sep = "&")
```

This yields:

```{r kable_cooccur_sep, echo=FALSE}
ex_cooccur_sep |>
  utils::head() |>
  knitr::kable()
```

## Associations

`gallicagram_associated`  builds a data frame the words the most frequently used following a given ngram over the period. 

For instance "camarade" is often followed by "staline" or "khrouchtchev" in Le Monde. The function returns the most frequent ngrams of the form "camarade \*". Setting `after = FALSE` also includes the most frequent ngrams of the form "\* camarade".

The keyword can be a 2-gram in the "books" and "press" corpora and a 3-gram in the "lemonde" corpus. Searching the "press" corpus can require a long running time. This function corresponds to the `Joker` route of the [API](https://regicid.github.io/api) and is analogous to the `Joker` option on [Ngram Viewer](https://books.google.com/ngrams/).

```{r ex_assoc}
ex_associated <- gallicagram_associated(
  keyword = "camarade",
  corpus = "lemonde",
  from = 1960,
  to = 1970
)
```

Here is an example of part of the output:

```{r kable_assoc, echo=FALSE}
ex_associated |>
  utils::head() |>
  knitr::kable()
```

# Searching several keywords

In order to search several keywords at once, we can use the function `purrr::map_dfr`. It takes as parameters the vector of keywords to search, followed by the function (`gallicagram`) and additional arguments to pass to the function. It returns a unique data frame with the results for searches corresponding to each keyword, basically binding the dataframes produced by each keyword search.

```{r map, eval=FALSE}
library(purrr)

keywords <- c("république", "france")

purrr::map_dfr(keywords, gallicagram,
               corpus = "lemonde", from = "1960", to = "1970")
```

Bbased on that same principle, we can run several searches at onces, varying all parameters, not only the keyword searched. To do that, we can specify the series of parameters in a data frame, each row corresponding to a set of parameters to run the `gallicagram` function for. We then pass this data frame to `purrr::pmap_dfr`. 

To specify the set of parameters, we can either build the parameters data frame by hand. It is also often helpful to use `tidyr::crossing` to create all combination of possible searches.

```{r params_pmap}
params_pmap <-
  tibble::tibble(
    from = 1850,
    to = 1870,
    resolution = "yearly"
  ) |>
  tidyr::crossing(corpus = c("press", "books")) |>
  tidyr::crossing(keyword = c("république", "france"))
```

The corresponding set of parameters to search looks like this:

```{r kable_params_pmap, echo=FALSE}
knitr::kable(params_pmap)
```

We can then pass it to `purrr::pmap_dfr` that will call the function `gallicagram` for each of the 4 sets of parameters defined in the rows of `params_pmap`:

```{r pmap, eval=FALSE}
purrr::pmap_dfr(params_pmap, gallicagram)
```

This method also apply for the other functions in the `rallicagram` package.

# Graphs

One of the main usage of `Gallicagram` is to plot time series of occurrences in a corpus. Here is an example graph using `ggplot` (and my own ggplot theme [`mediocrethemes`](https://vincentbagilet.github.io/mediocrethemes/). The use of this theme is of course not mandatory and one can remove the line `mediocrethemes::set_mediocre_all()`): 

```{r raw_ts, message=FALSE}
library(ggplot2)
mediocrethemes::set_mediocre_all()

ex_data <- gallicagram(
  keyword = "informatique", 
  corpus = "lemonde", 
  from = 1945, 
  to = 2022,
  resolution = "yearly"
)

ex_data |> 
  ggplot(aes(x = date, y = prop_occur)) + 
  geom_line() +
  labs(
    title = "Evolution of occurrences of 'computering' (informatique)",
    subtitle = "In the french newspaper Le Monde",
    x = NULL,
    y = "Proportion of occurrences"
  )
```

We can use `geom_smooth` to plot smoother lines. When using the default loess smoothing, the parameter `span` controls the amount of smoothing. Larger values are associated with less smoothing. Here is the same graph but smoothed:

```{r smoothed_ts}
ex_data |> 
  ggplot(aes(x = date, y = prop_occur)) + 
  geom_smooth(span = 0.2) +
  labs(
    title = "Evolution of occurrences of 'computering' (informatique)",
    subtitle = "In the french newspaper Le Monde",
    x = NULL,
    y = "Proportion of occurrences"
  )
```
